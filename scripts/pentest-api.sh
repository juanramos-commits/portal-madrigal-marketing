#!/bin/bash
# =============================================================================
# PENTEST BÁSICO - Portal Madrigal Marketing (app.madrigalmarketing.es)
# =============================================================================
# Uso: ./scripts/pentest-api.sh [BASE_URL]
# Ejemplo: ./scripts/pentest-api.sh https://app.madrigalmarketing.es
# =============================================================================

set -euo pipefail

BASE_URL="${1:-https://app.madrigalmarketing.es}"
SUPABASE_URL="${VITE_SUPABASE_URL:-https://ootncgtcvwnrskqtamak.supabase.co}"
PASS=0
FAIL=0
WARN=0

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

log_pass() { PASS=$((PASS+1)); echo -e "${GREEN}[PASS]${NC} $1"; }
log_fail() { FAIL=$((FAIL+1)); echo -e "${RED}[FAIL]${NC} $1"; }
log_warn() { WARN=$((WARN+1)); echo -e "${YELLOW}[WARN]${NC} $1"; }
log_info() { echo -e "      $1"; }

echo "============================================="
echo " Pentest API - Portal Madrigal Marketing"
echo " Fecha: $(date '+%Y-%m-%d %H:%M:%S')"
echo " Target: $BASE_URL"
echo "============================================="
echo ""

# -----------------------------------------------------------------------------
# TEST 1: Security Headers
# -----------------------------------------------------------------------------
echo "--- TEST 1: Security Headers ---"
HEADERS=$(curl -sI "$BASE_URL" 2>/dev/null || echo "")

check_header() {
  local header="$1"
  local expected="$2"
  if echo "$HEADERS" | grep -qi "$header"; then
    log_pass "$header presente"
  else
    log_fail "$header ausente"
  fi
}

check_header "X-Content-Type-Options" "nosniff"
check_header "X-Frame-Options" "DENY"
check_header "X-XSS-Protection" "1"
check_header "Referrer-Policy" "strict-origin"
check_header "Content-Security-Policy" "default-src"
check_header "Permissions-Policy" "camera"
echo ""

# -----------------------------------------------------------------------------
# TEST 2: HTTPS Redirect
# -----------------------------------------------------------------------------
echo "--- TEST 2: HTTPS Redirect ---"
HTTP_CODE=$(curl -sI -o /dev/null -w "%{http_code}" "http://$(echo $BASE_URL | sed 's|https://||')" 2>/dev/null || echo "000")
if [ "$HTTP_CODE" = "301" ] || [ "$HTTP_CODE" = "302" ] || [ "$HTTP_CODE" = "308" ]; then
  log_pass "HTTP redirige a HTTPS (código $HTTP_CODE)"
elif [ "$HTTP_CODE" = "000" ]; then
  log_warn "No se pudo verificar redirect HTTP (posible HSTS preload)"
else
  log_fail "HTTP no redirige a HTTPS (código $HTTP_CODE)"
fi
echo ""

# -----------------------------------------------------------------------------
# TEST 3: Supabase Auth - Protección endpoints
# -----------------------------------------------------------------------------
echo "--- TEST 3: API Auth sin credenciales ---"

# Intentar acceso sin API key
NOKEY_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$SUPABASE_URL/rest/v1/usuarios" 2>/dev/null || echo "000")
if [ "$NOKEY_CODE" = "401" ] || [ "$NOKEY_CODE" = "403" ]; then
  log_pass "API rechaza requests sin API key ($NOKEY_CODE)"
else
  log_fail "API accesible sin API key ($NOKEY_CODE)"
fi
echo ""

# -----------------------------------------------------------------------------
# TEST 4: SQL Injection básica
# -----------------------------------------------------------------------------
echo "--- TEST 4: SQL Injection basica ---"
SQLI_PAYLOADS=(
  "' OR 1=1--"
  "'; DROP TABLE usuarios;--"
  "1 UNION SELECT * FROM usuarios--"
)

for payload in "${SQLI_PAYLOADS[@]}"; do
  SQLI_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
    "$SUPABASE_URL/rest/v1/usuarios?nombre=eq.${payload}" \
    -H "apikey: invalid" 2>/dev/null || echo "000")
  if [ "$SQLI_CODE" = "401" ] || [ "$SQLI_CODE" = "403" ] || [ "$SQLI_CODE" = "400" ]; then
    log_pass "SQLi payload rechazado: $(echo $payload | head -c 20)..."
  else
    log_warn "Respuesta inesperada a SQLi payload ($SQLI_CODE)"
  fi
done
echo ""

# -----------------------------------------------------------------------------
# TEST 5: XSS en endpoints
# -----------------------------------------------------------------------------
echo "--- TEST 5: XSS reflection ---"
XSS_PAYLOAD="<script>alert(1)</script>"
XSS_RESPONSE=$(curl -s "$BASE_URL/?q=$XSS_PAYLOAD" 2>/dev/null || echo "")
if echo "$XSS_RESPONSE" | grep -q "<script>alert(1)</script>"; then
  log_fail "XSS reflejado detectado en query params"
else
  log_pass "No hay XSS reflejado en query params"
fi
echo ""

# -----------------------------------------------------------------------------
# TEST 6: Enumeración de usuarios
# -----------------------------------------------------------------------------
echo "--- TEST 6: Anti-enumeración de usuarios ---"

# Login con email inexistente
FAKE_RESP=$(curl -s -w "\n%{http_code}" \
  "$SUPABASE_URL/auth/v1/token?grant_type=password" \
  -H "apikey: ${VITE_SUPABASE_ANON_KEY:-invalid}" \
  -H "Content-Type: application/json" \
  -d '{"email":"noexiste@test.com","password":"TestPass123!"}' 2>/dev/null || echo "")

FAKE_CODE=$(echo "$FAKE_RESP" | tail -1)
FAKE_BODY=$(echo "$FAKE_RESP" | head -n -1)

# Login con email que podría existir
REAL_RESP=$(curl -s -w "\n%{http_code}" \
  "$SUPABASE_URL/auth/v1/token?grant_type=password" \
  -H "apikey: ${VITE_SUPABASE_ANON_KEY:-invalid}" \
  -H "Content-Type: application/json" \
  -d '{"email":"admin@madrigalmarketing.es","password":"WrongPass123!"}' 2>/dev/null || echo "")

REAL_CODE=$(echo "$REAL_RESP" | tail -1)

if [ "$FAKE_CODE" = "$REAL_CODE" ]; then
  log_pass "Respuestas idénticas para email existente y no existente (anti-enumeración)"
else
  log_warn "Códigos de respuesta diferentes ($FAKE_CODE vs $REAL_CODE) - posible enumeración"
fi
echo ""

# -----------------------------------------------------------------------------
# TEST 7: Rate Limiting
# -----------------------------------------------------------------------------
echo "--- TEST 7: Rate Limiting ---"
RATE_BLOCKED=false
for i in $(seq 1 15); do
  RL_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
    "$SUPABASE_URL/auth/v1/token?grant_type=password" \
    -H "apikey: ${VITE_SUPABASE_ANON_KEY:-invalid}" \
    -H "Content-Type: application/json" \
    -d '{"email":"ratetest@test.com","password":"bad"}' 2>/dev/null || echo "000")
  if [ "$RL_CODE" = "429" ]; then
    RATE_BLOCKED=true
    log_pass "Rate limit activado después de $i intentos"
    break
  fi
done
if [ "$RATE_BLOCKED" = "false" ]; then
  log_warn "Rate limit no detectado tras 15 intentos (puede estar en capa superior)"
fi
echo ""

# -----------------------------------------------------------------------------
# TEST 8: CORS
# -----------------------------------------------------------------------------
echo "--- TEST 8: CORS ---"
CORS_RESP=$(curl -sI -H "Origin: https://evil.com" "$SUPABASE_URL/rest/v1/" 2>/dev/null || echo "")
if echo "$CORS_RESP" | grep -qi "access-control-allow-origin: https://evil.com"; then
  log_fail "CORS permite origen malicioso (https://evil.com)"
elif echo "$CORS_RESP" | grep -qi "access-control-allow-origin: \*"; then
  log_warn "CORS permite todos los orígenes (*)"
else
  log_pass "CORS no permite orígenes no autorizados"
fi
echo ""

# -----------------------------------------------------------------------------
# TEST 9: Información sensible en respuestas
# -----------------------------------------------------------------------------
echo "--- TEST 9: Información sensible en respuestas ---"
ERROR_RESP=$(curl -s "$SUPABASE_URL/rest/v1/tabla_que_no_existe" \
  -H "apikey: ${VITE_SUPABASE_ANON_KEY:-invalid}" 2>/dev/null || echo "")

if echo "$ERROR_RESP" | grep -qi "stack trace\|pg_catalog\|postgresql\|internal error"; then
  log_fail "Información de stack/DB en respuestas de error"
else
  log_pass "No hay información sensible en errores"
fi
echo ""

# -----------------------------------------------------------------------------
# TEST 10: Clickjacking
# -----------------------------------------------------------------------------
echo "--- TEST 10: Clickjacking ---"
if echo "$HEADERS" | grep -qi "X-Frame-Options: DENY"; then
  log_pass "Protección clickjacking activa (X-Frame-Options: DENY)"
elif echo "$HEADERS" | grep -qi "frame-ancestors 'none'"; then
  log_pass "Protección clickjacking activa (CSP frame-ancestors)"
else
  log_fail "Sin protección contra clickjacking"
fi
echo ""

# -----------------------------------------------------------------------------
# RESUMEN
# -----------------------------------------------------------------------------
echo "============================================="
echo " RESUMEN"
echo "============================================="
echo -e " ${GREEN}PASS: $PASS${NC}"
echo -e " ${RED}FAIL: $FAIL${NC}"
echo -e " ${YELLOW}WARN: $WARN${NC}"
echo " TOTAL: $((PASS + FAIL + WARN))"
echo "============================================="

if [ "$FAIL" -gt 0 ]; then
  echo -e "${RED}HAY FALLOS QUE REQUIEREN ATENCIÓN${NC}"
  exit 1
else
  echo -e "${GREEN}Sin fallos críticos detectados${NC}"
  exit 0
fi
