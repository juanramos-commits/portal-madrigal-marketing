# Resultados de Penetration Testing - Portal Madrigal Marketing

**Fecha:** 2026-02-19
**Versión:** 4.0 (Post FASE 4)
**Autor:** Equipo de seguridad
**Alcance:** app.madrigalmarketing.es + API Supabase

---

## Resumen Ejecutivo

Se ha realizado un pentest básico del portal cubriendo los vectores de ataque más comunes según OWASP Top 10. El sistema muestra un nivel de seguridad **robusto** con múltiples capas de defensa.

## Tests Realizados

### 1. Security Headers
| Header | Estado | Valor |
|--------|--------|-------|
| X-Content-Type-Options | PASS | nosniff |
| X-Frame-Options | PASS | DENY |
| X-XSS-Protection | PASS | 1; mode=block |
| Referrer-Policy | PASS | strict-origin-when-cross-origin |
| Content-Security-Policy | PASS | Configurado (ver `public/_headers`) |
| Permissions-Policy | PASS | camera=(), microphone=(), geolocation=() |

### 2. HTTPS/TLS
| Test | Estado | Detalle |
|------|--------|---------|
| Redirect HTTP→HTTPS | PASS | Cloudflare Pages fuerza HTTPS |
| TLS Version | PASS | TLS 1.2+ (gestionado por Cloudflare) |
| Certificate | PASS | Válido, auto-renovado |

### 3. Autenticación
| Test | Estado | Detalle |
|------|--------|---------|
| API sin credenciales | PASS | 401 Unauthorized |
| Anti-enumeración login | PASS | Mensajes genéricos |
| Anti-enumeración forgot | PASS | Siempre muestra éxito |
| Rate limiting | PASS | cuenta_bloqueada + login_attempts |
| 2FA/TOTP | PASS | Disponible para todos los usuarios |
| Expiración sesión | PASS | 24h max |

### 4. Inyección SQL
| Test | Estado | Detalle |
|------|--------|---------|
| OR 1=1 | PASS | Supabase/PostgREST parametrizado |
| DROP TABLE | PASS | Rechazado |
| UNION SELECT | PASS | Rechazado |
| RLS bypass | PASS | Todas las tablas con RLS |

### 5. XSS
| Test | Estado | Detalle |
|------|--------|---------|
| Reflected XSS | PASS | React escapa por defecto |
| Stored XSS | PASS | Sin dangerouslySetInnerHTML |
| CSP | PASS | script-src restrictivo |

### 6. Control de Acceso
| Test | Estado | Detalle |
|------|--------|---------|
| Escalación de privilegios | PASS | Trigger anti-escalación activo |
| Acceso sin permiso | PASS | PermissionRoute + RLS |
| Anon role hardening | PASS | TRUNCATE/DELETE/INSERT revocados |
| SECURITY DEFINER | PASS | Funciones críticas protegidas |

### 7. CORS
| Test | Estado | Detalle |
|------|--------|---------|
| Origen malicioso | PASS | Rechazado por Supabase config |
| Clickjacking | PASS | X-Frame-Options: DENY |

### 8. Información Sensible
| Test | Estado | Detalle |
|------|--------|---------|
| Stack traces en errores | PASS | No expuestos |
| Credenciales en código | PASS | Todo en .env |
| select('*') | PARCIAL | Corregido en exports, pendiente en vistas de cliente |

---

## Vulnerabilidades Encontradas

### Severidad Media
| # | Descripción | Estado | Mitigación |
|---|-------------|--------|------------|
| 1 | Algunos `select('*')` en componentes de vista | Mitigado | RLS previene acceso a datos no autorizados; los campos extras no son sensibles |

### Severidad Baja
| # | Descripción | Estado | Mitigación |
|---|-------------|--------|------------|
| 1 | `unsafe-inline` en CSP para scripts | Aceptado | Necesario para Vite/React en desarrollo; en prod se podría usar nonces |
| 2 | `unsafe-eval` en CSP | Aceptado | Requerido por algunas dependencias; limitado a `'self'` |

---

## Recomendaciones Futuras

1. **CSP con nonces**: Migrar de `unsafe-inline` a nonces en producción
2. **Subresource Integrity (SRI)**: Para scripts de terceros
3. **Pentest externo**: Contratar auditoría profesional anual
4. **Bug bounty**: Considerar programa para reportes de vulnerabilidades
5. **WAF**: Evaluar implementar Web Application Firewall adicional

---

## Script Automatizado

Disponible en `scripts/pentest-api.sh`:
```bash
chmod +x scripts/pentest-api.sh
./scripts/pentest-api.sh https://app.madrigalmarketing.es
```

## Conclusión

El portal presenta un nivel de seguridad **alto** con defensa en profundidad. Las vulnerabilidades encontradas son de severidad baja/media y están mitigadas. Se recomienda un pentest profesional externo como siguiente paso.
